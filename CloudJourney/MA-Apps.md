# アプリケーションのモダン認証対応 (WIP)
## 概要
クラウド利用が主流の時代では、アプリケーションをどこからでも安全に利用できることが必須要件になり、Azure AD 等の IDaaS に認証連携し、条件付きアクセス等の高度なセキュリティ、運用・監査等のメリットを享受していくことが必要とされてきています。  
このドキュメントは、特に Web アプリケーションを対象に、アプリケーションの認証のモダン化の方法を整理します。

## モダン認証方式の定義
このドキュメントにおけるモダン認証方式の定義は、Azure AD や主要な IDaaS がサポートしているオープンな認証プロトコルを利用したもので、アプリの配置場所に影響されることはありませせん。実質的には、以下２つの認証プロトコルを利用したものに絞られます（WS-Federation 対応のアプリケーションを作成することはあまり一般的ではないため、対象外とします）。
* [Open ID Connect (+OAuth2)](https://www.openid.or.jp/document/index.html)
* SAML-P

一方、以下がモダン認証方式ではない方式の代表例です。このドキュメントでは、「オンプレミス認証方式」と呼びます。
* 統合 Windows 認証 (Kerberos、NTLM)
* LDAP 認証
* ヘッダー認証

## 推奨事項
Azure AD を ID プロバイダーとするアプリを、できるだけ改修コストを抑えて実装する、という観点での推奨を「新規に実装するアプリ」、「既存のアプリを移行する」という2つの観点で考慮すべき順番を記載します。  
※ アプリ実装方法検討の前に考えるべきポイント、アプリを必要とする業務をアウトソースする、アプリを自社開発・管理せずに SaaS を利用する、等についてはこのドキュメントには含んでいません。

まず、新規に実装するアプリ等、利用する認証プロトコルが選択できる場合には、OpenID Connect を先に検討すべきです。これは、SAML-P よりもライブラリが豊富で実装の容易性、利用シナリオの幅が広い (ネイティブアプリにも適している等)、構成・トラブルシューティングの容易性、といった理由が挙げられます。

新規アプリをモダン認証方式に対応する際、検討する順番  
1. Azure App Service 上で動作する PaaS アプリとして実装する
2. Visual Studio で実装し、認証連携機能を組み込む
3. MSAL/ADAL 等の認証ライブラリを利用して実装する

既存のアプリをモダン認証方式に変更する際、検討する順番
1. Azure App Service 上へ移行する
2. Visual Studio で認証連携機能を組み込む
3. MSAL/ADAL 等の認証ライブラリを利用して実装する
4. ミドルウェアで対応する
5. リバースプロキシで対応する
6. Azure AD Application Proxy を利用する

※ あくまでも一般的な検討順番で、ビジネスの背景、開発体制、また、アプリの特性や複雑性などによって企業ごとに優先順位は変化します。また、複数方式の組み合わせるパターンもあります。

## 対応方法サマリー
既存の「オンプレミス認証方式」アプリを「モダン認証方式」へ移行し、Azure AD と認証連携する、という観点で対応方法を整理します。大きく分類すると、**アプリのコード改修で対応する方法**と、**インフラ側で対応する方法**の2パターンがあります。  
どの方式を選択しても、Azure AD を ID プロバイダとして利用しますので、条件付きアクセス等、Azure AD の提供するセキュリティや運用・監査のメリットを享受できます。  
インフラ側で対応する方法は、インフラレベルで認証プロトコル変換する、という考え方で、比較的容易にセキュリティや運用のメリットを享受できる手っ取り早さはあるものの、アプリの配置場所に影響しない認証方式、ということにはつながりません。

#### アプリコード改修で対応
| # | 移行方法  | コード改修工数 | コメント |
|---|---|---|---|
| A-1 | Azure App Service へ移行して PaaS 化 | 小～大 | シンプルな認証対応は、ほぼノンコーディングで実現可能。データをローカルディスク等に保存するアプリだとPaaS化改修が高くなる等、一般的な PaaS 化 の考慮点が適用される。 |
| A-2 | Visual Studio で認証連携機能を組み込む | 小～大 | 既存アプリが VS で作成されている場合には非常に有効で、シンプルな認証ロジックであれば、ほぼノンコーディングで実現可能。複雑な認可ロジックを実装している場合には要コード修正部分が多くなりがち。 |
| A-3 | MSAL/ADAL 等の認証ライブラリを組み込む | 中～大 | VS で作成されてないアプリに対し、認証ライブラリを使って組み込む。シンプルな認証ロジックであれば、比較的少ないコード量で実現可能。複雑な認可ロジックを実装している場合にはコード修正量が多くなりがち。 |
| A-4 | 自ら OIDC/SAML を実装してコード改修 | 大 | 整理のために記載するが、実質的にこの方法を選択することは無い。 |

#### インフラで対応（アプリのコード改修は原則不要）
| # | 移行方法  | インフラ構成対応工数 | コメント |
|---|---|---|---|
| I-1 | ミドルウェアで対応 | 小～中 | 対応モジュールのある Apache にて利用可能。IIS 用のモジュールは存在しない。インフラ側に分類したが、場合によってはアプリ側に分類するケースも考えられる。 |
| I-2 | リバースプロキシで対応 | 中～大 | アプリサーバーの前段にリバプロを配置して認証を仲介。多くのアプリサーバーがある場合に効果的。 |
| I-3 | Azure AD Application Proxy を利用 | 小～中 | I-2 と同じ考え方で、リバプロとして AppProxy を利用する。AppProxy 用のコネクタサーバーの用意が必要。 |


### A-1 : Azure App Service の認証連携機能を利用する
[Azure App Service](https://docs.microsoft.com/ja-jp/azure/app-service/overview) を利用してアプリを PaaS 上で運用すると、シンプルな認証・認可であれば、最小限のコードで非常に簡単に実装することが可能です。[Azure App Service](https://docs.microsoft.com/ja-jp/azure/app-service/overview) は、.NET、.NET Core、Java、Ruby、Node.js、PHP、Python　等の様々なプログラミング言語に対応しています。詳しくは、[Azure App Service での認証および認可](https://docs.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization) をご参考ください。  
配置場所が Azure になるため、「どこからでも利用できるアプリ」になります。  
新しく作成する Web アプリケーションについてはもちろん、オンプレミス、または、IaaS のサーバー上で運用しているアプリケーションを移行することを検討することをお奨めしますが、その場合、一般的な PaaS 化の考慮点が適用されます。たとえば、永続的データをローカルディスクに保存するようなアーキテクチャのアプリであれば、抜本的にデータストアの変更が必要になります。詳しくは、[Azure アーキテクチャ センター](https://docs.microsoft.com/ja-jp/azure/architecture/) を参考ください。

### A-2 : Visual Studio の認証連携機能を利用する
Visual Studio を利用してアプリ開発をする場合、シンプルな認証・認可の実装をほぼノンコーディングで実現可能です。実質的には、A-3 と同じく MSAL/ADAL などの認証ライブラリを利用することになりますが、IDE に統合され、設定レベルで実装可能です。詳しくは、[Visual Studio の接続済みサービスを利用して Azure Active Directory を追加する](https://docs.microsoft.com/ja-jp/azure/active-directory/develop/vs-active-directory-add-connected-service) をご参考ください。
「どこからでも利用できるアプリ」になるかは、配置場所によります。  

### A-3 : MSAL/ADAL 等の認証ライブラリを利用する
もし、高度な認証・認可ロジックが必要、Visual Studio 意外の IDE を利用して開発するような場合には、MSAL/ADAL を認証ライブラリを利用して実装します。ADAL は、.NET、JavaScript、iOS、Android、Java、および Python をサポートしています。MSAL プレビューは、.NET、JavaScript、iOS、および Android をサポートしています。これらを利用したアプリパターンやプログラミング言語毎にサンプルコードも豊富に用意されているため、利用に際しての障壁は比較的低いはずです。詳しくは、[開発者向け Azure Active Directory](https://docs.microsoft.com/ja-jp/azure/active-directory/develop/) をご参考ください。  
また、その他のライブラリについても、[Certified Relying Party Servers and Services](https://openid.net/developers/certified/#RPLibs) をご参考ください。  
「どこからでも利用できるアプリ」になるかは、配置場所によります。  

### I-1 : ミドルウェアで対応する
アプリのコード改修による費用対効果が見込めない場合には、工数が比較的低いミドルウェアレベルで対応できるか検討します。たとえば、Apache で利用できる [mod_auth_openidc](https://github.com/zmartzone/mod_auth_openidc) を利用することで、Apache サーバーを OpenID Connect の Relying Party とすることができます。ただし、認証プロトコルの変換だけで、インターネットからの社内配置アプリ利用、というシナリオの実現には、別途VPNや別なリバプロ等の仕組みが必要になります。     
現時点では、IIS 用の対応モジュールはリリースされていませんが、マイクロソフトはその必要性や有用性を検討している段階です。  
「どこからでも利用できるアプリ」になるかは、配置場所によります。  

### I-2 : リバースプロキシを利用する
I-1 の応用編になりますが、[mod_auth_openidc](https://github.com/zmartzone/mod_auth_openidc) を実装した Apache サーバーをリバースプロキシとして動作させ、既存のアプリの前段に配置することで、アプリのコードを改修することなく、OpenID Connect の Relying Party とすることが可能です。複数のアプリサーバーを対象にしたい場合に効果的です。また、この方式だと IIS やその他のミドルウェアにも対応可能です。
クライアントからアプリサーバーへは必ずリバプロ経由でアクセスするよう、ネットワークまわりの再設計を伴います。  
このリバプロの役割は、認証プロトコルの変換だけで、「どこからでも利用できるアプリ」にするには、別途VPNや別なリバプロ等の仕組みが必要になります。   
[OpenID ファウンデーションジャパンの Enterprise Idenity Wokring Group が公開しているドキュメント](https://eiwg.openid.or.jp/phase3/samples/implementation/mod_auth_openidc) をご参考ください。

### I-3 : Azure AD Application Proxy を利用する
I-2 の応用編になりますが、リバースプロキシとして [Azure AD Application Proxy](https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy) を利用します。複数のアプリサーバーを対象にしたい場合に効果的です。  
I-2 と大きく異なる点は、認証プロトコルの変換だけでなく、同時に「どこからでも利用できるアプリ」になります。  
クライアントからアプリサーバーへは必ずリバプロ経由でアクセスするよう、ネットワークまわりの再設計を伴います。  
クライアントの場所にかかわらず、全てのトラフィックは Azure AD 経由、つまりインターネット経由になります。もし、社内ネットワークに存在するクライアントからのアクセスをインターネット経由にしたくない場合には、認証プロトコル変換を I-2 の方式で実現、インターネットからのアプリ利用というシナリオを Azure AD Application Proxy を使って実現します。  
オンプレミス環境に、コネクタサーバーを配置するなど、[Azure AD Application Proxy を利用するための準備](https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy-add-on-premises-application) が必要になります。
